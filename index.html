<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tracker & Compass – Satellite View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0;}
    /* Intro overlay */
    #intro{
      position:fixed;inset:0;background:rgba(0,0,0,0.75);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      color:#fff;font-family:sans-serif;text-align:center;gap:1.2rem;z-index:9999;
    }
    #intro button{padding:0.6rem 1.2rem;border:none;border-radius:6px;background:#2e86ab;color:#fff;font-size:1rem;cursor:pointer;}
  </style>
</head>
<body>
  <div id="intro">
    <h2 style="margin:0">Welcome</h2>
    <p style="margin:0 1rem">Start bottle-message adventure</p>
    <button id="startBtn">Okay</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <script>
    /***** CONFIG *****/
    const PUBLIC_SHARE_ID='b995bb953c';
    const POLLING_MS=15000;
    const TRACKER_ENDPOINT = `https://floral-bread-d4f1.goldinger.workers.dev/b995bb953c`; // swap proxy if needed

    /***** MAP *****/
    const map=L.map('map',{zoomControl:true,inertia:true}).setView([0,0],13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      attribution:'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',
      maxZoom:19
    }).addTo(map);

    /***** ICONS *****/
    const trackerIcon=L.icon({iconUrl:'img/tracker-icon3.png',shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],shadowSize:[41,41]});
    const userIcon=L.icon({iconUrl:'img/sscro-arrow.png',iconSize:[45,45],iconAnchor:[22,40],popupAnchor:[0,-40]});

    /***** STATE *****/
    let trackerMarker,userMarker,watchId;
    function fit(){const g=L.featureGroup([trackerMarker,userMarker].filter(Boolean));if(g.getLayers().length&&!userInteracted)map.fitBounds(g.getBounds().pad(.25));}

    // stop auto-fit after manual zoom/drag
    let userInteracted=false;
    map.on('zoomstart dragstart',()=>{userInteracted=true;});

    /***** TRACKER FETCH *****/
    async function updateTracker(){try{const r=await fetch(TRACKER_ENDPOINT);if(!r.ok)throw new Error(r.statusText);const d=await r.json();const lat=d.lat??d.position?.lat;const lng=d.lng??d.lon??d.position?.lng??d.position?.lon;if(lat==null||lng==null)return;if(!trackerMarker){trackerMarker=L.marker([lat,lng],{icon:trackerIcon}).addTo(map).bindPopup('Tracker');}else{trackerMarker.setLatLng([lat,lng]);}fit();}catch(err){console.error('tracker fetch',err);}}

    /***** COMPASS HELPERS *****/
    function headingFromEvent(e){if('webkitCompassHeading'in e&&Number.isFinite(e.webkitCompassHeading))return e.webkitCompassHeading;if(Number.isFinite(e.alpha))return(360-e.alpha)%360;return null;}
    function enableOrientation(){if(!('DeviceOrientationEvent'in window))return;window.addEventListener('deviceorientation',e=>{const h=headingFromEvent(e);if(h!=null&&userMarker)userMarker.setRotationAngle(h);},true);}

    /***** START BUTTON HANDLER *****/
    document.getElementById('startBtn').addEventListener('click',()=>{
      document.getElementById('intro').remove();
      // Geolocation
      if('geolocation'in navigator){watchId=navigator.geolocation.watchPosition(({coords})=>{
        const {latitude,longitude,heading}=coords;
        if(!userMarker){userMarker=L.marker([latitude,longitude],{icon:userIcon,rotationAngle:heading||0,rotationOrigin:'center bottom'}).addTo(map).bindPopup('Your position');}
        else{userMarker.setLatLng([latitude,longitude]);if(Number.isFinite(heading))userMarker.setRotationAngle(heading);}fit();
      },console.warn,{enableHighAccuracy:true,maximumAge:0});}

      // Compass permission (iOS needs explicit)
      if(typeof DeviceOrientationEvent==='function'&&typeof DeviceOrientationEvent.requestPermission==='function'){
        DeviceOrientationEvent.requestPermission().then(p=>{if(p==='granted')enableOrientation();});
      }else{enableOrientation();}

      // start tracker polling
      updateTracker();setInterval(updateTracker,POLLING_MS);
    },{once:true});
  </script>
</body>
</html>
