<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SSCRo - Letzte Runde 2025: John Bottle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" sizes="42x32" href="favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0;}
    #intro{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);color:#fff;gap:1rem;z-index:9999;font-family:sans-serif;text-align:center}
    #intro img{width:72px;height:auto}
    #intro button{padding:.6rem 1.2rem;border:none;border-radius:6px;background:#2e86ab;color:#fff;font-size:1rem;cursor:pointer}
    /* custom divIcon classes */
    .tracker-icon{background:url('img/tracker-icon.png') center/contain no-repeat;width:25px;height:41px;}
     /* red border when live */
    .zone-alert{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#f7b324;color:#000;padding:.6rem 1.2rem;border-radius:6px;font-family:sans-serif;font-weight:bold;font-size:1.1rem;z-index:9998;display:none}
  </style>
</head>
<body>
  <div id="intro">
    <img src="img/intro-icon.png" alt="intro icon" style="width:120px;height:auto;margin-bottom:1rem;">
    <h2 style="margin:0">SSCRo - Letzte Runde 2025</h2>
    <p style="margin:0 1rem">Auf der Suche nach der Flaschenpost von Captain John Bottle! Bitte bestätige nach dem Start, dass die GPS- und Kompass-Funktion verwendet werden darf.</p>
    <button id="startBtn">Start</button>
  </div>

  <div id="map"></div>
  <div id="zoneMsg" class="zone-alert">Das ist der Place to be für das Feuerwerk! Happy 1.August. Pröschterli Brudi!</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <script>
    const PUBLIC_SHARE_ID='b995bb953c';
    const POLLING_MS=15000;
    const TRACKER_ENDPOINT=`https://floral-bread-d4f1.goldinger.workers.dev/${PUBLIC_SHARE_ID}`;

     // Zone settings (center & radius in metres)
    const ZONE_CENTER = [47.126430, 9.296480];   // Home: 47.197610, 8.650484 walensee: [47.126430, 9.296480]
    const ZONE_RADIUS = 50;                     // metres (walensee = 50)

    const map=L.map('map',{zoomControl:true,inertia:true}).setView([0,0],13);
    const satellite=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',maxZoom:21}).addTo(map);

    const intro=document.getElementById('intro');
    satellite.once('tileload',()=>{intro.style.display='flex';});

    /* ICONS */
    const userIcon=L.icon({iconUrl:'img/user-arrow.png',iconSize:[45,80],iconAnchor:[22,40],popupAnchor:[0,-40]});
    const trackerIconStatic = L.divIcon({
        className: 'tracker-icon',
        iconSize:  [110, 110],    // tell Leaflet the real size
        iconAnchor:[55, 110],       // x-center, y-bottom (a few px above edge)
        popupAnchor:[0,-40]    
    });

     const freddyIcon = L.icon({
      iconUrl   : 'img/freddy-location.png', //img/freddy-location.png
      iconSize  : [60, 90],      // image dimensions 60x90
      iconAnchor: [60, 100]       // x-offset, y-offset from top‑left of image to lat/lon anchor 60x100
    });

    /* ZONE CIRCLE */
    const zoneCircle = L.circle(ZONE_CENTER,{radius:ZONE_RADIUS,color:'#d42604',fillOpacity:0.1}).addTo(map);
    const freddyMarker = L.marker(ZONE_CENTER,{icon:freddyIcon,interactive:false}).addTo(map);

    // scale freddy icon with zoom, similar to circle
    const BASE_ZOOM = 13;                      // zoom level where icon is 60×60
    const BASE_WIDTH = 60;
    const BASE_HEIGHT = 90;
    const BASE_ANCHOR = { x: 60, y: 100 }; // anchor we set in iconAnchor
    
    function scaleFreddy(){
      const z      = map.getZoom();
      const raw    = map.getZoomScale(z, BASE_ZOOM);   // <1 when zoomed-out, >1 when in
      const scale  = Math.min(1, raw);                  // clamp so icon never larger than original
      const pxSizeWidth = BASE_WIDTH * scale;
      const pxSizeHeight = BASE_HEIGHT * scale;
       // anchor scales by the same factor
      const ax = BASE_ANCHOR.x * scale;
      const ay = BASE_ANCHOR.y * scale;
      const el     = freddyMarker.getElement();
      if(!el) return;
      el.style.width       = `${pxSizeWidth}px`;
      el.style.height      = `${pxSizeHeight}px`;
      el.style.marginLeft  = `${-pxSizeWidth/2}px`;
      el.style.marginTop   = `${-pxSizeHeight}px`;
      el.style.transformOrigin = '0 0';   // ensure margin maths is respected
    }
    map.off('zoom', scaleFreddy).on('zoom', scaleFreddy);
    scaleFreddy();
    map.on('zoom zoomend', scaleFreddy);
    scaleFreddy();
    
   
    /* STATE */
    let trackerMarker,userMarker;
    let lastLive=false;let userInteracted=false;
    map.on('zoomstart dragstart',()=>{userInteracted=true;});

    let insideZone=false;
    const zoneMsg = document.getElementById('zoneMsg');
    
    //function fit(){const g=L.featureGroup([trackerMarker,userMarker].filter(Boolean));if(g.getLayers().length&&!userInteracted)map.fitBounds(g.getBounds().pad(.25));}
    function fit(){const g=L.featureGroup([trackerMarker,userMarker,zoneCircle]);if(g.getLayers().length&&!userInteracted)map.fitBounds(g.getBounds().pad(.25));}
    
    const headingFromEvent=e=>('webkitCompassHeading'in e&&Number.isFinite(e.webkitCompassHeading)?e.webkitCompassHeading:Number.isFinite(e.alpha)?(360-e.alpha)%360:null);

    document.getElementById('startBtn').addEventListener('click',async()=>{
      intro.remove();
      if('geolocation'in navigator){navigator.geolocation.watchPosition(({coords})=>{const{latitude,longitude,heading}=coords;if(!userMarker){userMarker=L.marker([latitude,longitude],{icon:userIcon,rotationAngle:heading||0,rotationOrigin:'center center'}).addTo(map).bindPopup('Sailor\'s position and heading');}else{userMarker.setLatLng([latitude,longitude]);if(Number.isFinite(heading))userMarker.setRotationAngle(heading);}checkZone([latitude,longitude]);fit();},console.warn,{enableHighAccuracy:true,maximumAge:0});}
      if(typeof DeviceOrientationEvent==='function'&&typeof DeviceOrientationEvent.requestPermission==='function'){try{const p=await DeviceOrientationEvent.requestPermission();if(p==='granted')enableOrientation();}catch{console.warn('orientation denied');}}else{enableOrientation();}
      updateTracker();setInterval(updateTracker,POLLING_MS);
    },{once:true});

    function enableOrientation(){if(!('DeviceOrientationEvent'in window))return;window.addEventListener('deviceorientation',e=>{const h=headingFromEvent(e);if(h!=null&&userMarker)userMarker.setRotationAngle(h);},true);}    
    
    /* ZONE CHECK */
    function checkZone([lat,lon]){
      const dist=map.distance([lat,lon],ZONE_CENTER);
      if(dist<=ZONE_RADIUS && !insideZone){insideZone=true;zoneMsg.style.display='block';}
      else if(dist>ZONE_RADIUS && insideZone){insideZone=false;zoneMsg.style.display='none';}
    }
    
    async function updateTracker(){try{const r=await fetch(TRACKER_ENDPOINT);if(!r.ok)throw new Error(r.statusText);const d=await r.json();const lat=d.lat??d.position?.lat;const lng=d.lng??d.lon??d.position?.lng??d.position?.lon;if(lat==null||lng==null)return;const live=d.lt_active===true;const speed=d.speed;const alt=d.alt;const ts=new Date((d.time||Date.now()/1000)*1000).toLocaleTimeString();const popupHtml=`<strong>Bottle\'s position</strong><br>${live?'<span style=\"color:#e63946;font-weight:bold\">LIVE TRACKING</span>':''}<br>Last Update: ${ts}<br>Speed: ${speed??'–'} m/s<br>Altitude: ${alt??'–'} m`;
      const icon=trackerIconStatic;
      if(!trackerMarker){trackerMarker=L.marker([lat,lng],{icon}).addTo(map).bindPopup(popupHtml);}else{trackerMarker.setLatLng([lat,lng]);trackerMarker.setIcon(icon);trackerMarker.setPopupContent(popupHtml);}fit();
      // auto popup based on live status
      if(live&&!lastLive){trackerMarker.openPopup();}
      else if(!live&&lastLive){trackerMarker.closePopup();}
      lastLive=live;
    }catch(err){console.error('tracker',err);}}
  </script>
</body>
</html>
