<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tracker & Compass – Satellite View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0;}
    #intro{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);color:#fff;gap:1rem;z-index:9999;font-family:sans-serif;text-align:center}
    #intro img{width:72px;height:auto}
    #intro button{padding:.6rem 1.2rem;border:none;border-radius:6px;background:#2e86ab;color:#fff;font-size:1rem;cursor:pointer}
    /* custom divIcon classes */
    .tracker-icon{background:url('img/tracker-icon.png') center/contain no-repeat;width:110px;height:110px;}
    .tracker-live{border:3px solid #e63946;border-radius:12px;} /* red border when live */
  </style>
</head>
<body>
  <div id="intro">
    <img src="img/intro-icon.png" alt="intro icon" />
    <h2 style="margin:0">Welcome</h2>
    <p style="margin:0 1rem">Start bottle-message adventure</p>
    <button id="startBtn">Okay</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <script>
    const PUBLIC_SHARE_ID='b995bb953c';
    const POLLING_MS=15000;
    const TRACKER_ENDPOINT=`https://floral-bread-d4f1.goldinger.workers.dev/${PUBLIC_SHARE_ID}`;
    //const TRACKER_ENDPOINT = `https://floral-bread-d4f1.goldinger.workers.dev/b995bb953c`;

    const map=L.map('map',{zoomControl:true,inertia:true}).setView([0,0],13);
    const satellite=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',maxZoom:21}).addTo(map);

    const intro=document.getElementById('intro');
    satellite.once('tileload',()=>{intro.style.display='flex';});

    /* ICONS */
    const userIcon=L.icon({iconUrl:'img/user-arrow.png',iconSize:[45,45],iconAnchor:[22,40],popupAnchor:[0,-40]});
    const trackerIconStatic=L.divIcon({className:'tracker-icon'});
    const trackerIconLive=L.divIcon({className:'tracker-icon tracker-live'});

    /* STATE */
    let trackerMarker,userMarker;let userInteracted=false;
    map.on('zoomstart dragstart',()=>{userInteracted=true;});

    function fit(){const g=L.featureGroup([trackerMarker,userMarker].filter(Boolean));if(g.getLayers().length&&!userInteracted)map.fitBounds(g.getBounds().pad(.25));}

    const headingFromEvent=e=>('webkitCompassHeading'in e&&Number.isFinite(e.webkitCompassHeading)?e.webkitCompassHeading:Number.isFinite(e.alpha)?(360-e.alpha)%360:null);

    document.getElementById('startBtn').addEventListener('click',async()=>{
      intro.remove();
      if('geolocation'in navigator){navigator.geolocation.watchPosition(({coords})=>{const{latitude,longitude,heading}=coords;if(!userMarker){userMarker=L.marker([latitude,longitude],{icon:userIcon,rotationAngle:heading||0,rotationOrigin:'center bottom'}).addTo(map).bindPopup('Your position');}else{userMarker.setLatLng([latitude,longitude]);if(Number.isFinite(heading))userMarker.setRotationAngle(heading);}fit();},console.warn,{enableHighAccuracy:true,maximumAge:0});}
      if(typeof DeviceOrientationEvent==='function'&&typeof DeviceOrientationEvent.requestPermission==='function'){try{const p=await DeviceOrientationEvent.requestPermission();if(p==='granted')enableOrientation();}catch{console.warn('orientation denied');}}else{enableOrientation();}
      updateTracker();setInterval(updateTracker,POLLING_MS);
    },{once:true});

    function enableOrientation(){if(!('DeviceOrientationEvent'in window))return;window.addEventListener('deviceorientation',e=>{const h=headingFromEvent(e);if(h!=null&&userMarker)userMarker.setRotationAngle(h);},true);}    

    async function updateTracker(){try{const r=await fetch(TRACKER_ENDPOINT);if(!r.ok)throw new Error(r.statusText);const d=await r.json();const lat=d.lat??d.position?.lat;const lng=d.lng??d.lon??d.position?.lng??d.position?.lon;if(lat==null||lng==null)return;const live=d.lt_active===true;const speed=d.speed;const ts=new Date((d.time||Date.now()/1000)*1000).toLocaleTimeString();const popupHtml=`<strong>Tracker</strong><br>Time: ${ts}<br>Speed: ${speed??'–'} m/s`;
      const icon=live?trackerIconLive:trackerIconStatic;
      if(!trackerMarker){trackerMarker=L.marker([lat,lng],{icon}).addTo(map).bindPopup(popupHtml);}else{trackerMarker.setLatLng([lat,lng]);trackerMarker.setIcon(icon);trackerMarker.setPopupContent(popupHtml);}fit();}catch(err){console.error('tracker',err);}}
  </script>
</body>
</html>
