<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SSCRo â€“ Letzte Runde 2025: John Bottle</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="icon" href="https://sscro.sweyni-heli.ch/favicon32x32.png" sizes="32x32">
  <link rel="icon" href="https://sscro.sweyni-heli.ch/favicon192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="https://sscro.sweyni-heli.ch/favicon180x180.png">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map{height:100%;margin:0;}

    /* intro overlay */
    #intro{
      position:fixed;inset:0;display:none;flex-direction:column;
      align-items:center;justify-content:center;background:rgba(0,0,0,.2);
      color:#fff;gap:1rem;z-index:9999;font-family:sans-serif;text-align:center
    }
    #intro img{width:120px;height:auto;margin-bottom:1rem}
    #intro button{
      padding:.6rem 1.2rem;border:none;border-radius:6px;
      background:#2e86ab;color:#fff;font-size:1rem;cursor:pointer
    }

    /* tracker pin (bottle) */
    .tracker-icon{
      background:url('img/tracker-icon.png') center/contain no-repeat;
      width:25px;height:41px;
    }

    /* zone-entry banner */
    .zone-alert{
      position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
      background:#f7b324;color:#000;font-weight:bold;font-size:1.1rem;
      padding:.6rem 1.2rem;border-radius:6px;font-family:sans-serif;
      z-index:9998;display:none
    }

    #hudDistance{
      position:fixed; top:10px; left:50px; background:#f7b324;color:#000;font-weight:bold;
      font-family:sans-serif; font-size:16px; z-index:9998;
    }
  </style>
</head>
<body>
  <!-- INTRO OVERLAY -->
  <div id="intro">
    <img src="img/intro-icon.png" alt="intro icon" />
    <h2 style="margin:0">SSCRo â€“ Letzte Runde 2025</h2>
    <p style="margin:0 1rem">
      Auf der Suche nach der Flaschenpost von Captain&nbsp;John&nbsp;Bottle und dem
      Wrack der HMS Corkscrew!<br />
      Bitte bestÃ¤tige nach dem Start, dass GPS- und Kompass-Funktionen verwendet
      werden dÃ¼rfen.
    </p>
    <p style="font-size:1.3rem;font-weight:bold">Das Abenteuer beginnt in:</p>
    <p id="countdown" style="font-size:1.3rem;font-weight:bold"></p>
    <button id="startBtn">Start</button>
  </div>

  <!-- MAP + ZONE MESSAGE -->
  <div id="map"></div>
  <div id="hudDistance"></div>
  <div id="zoneMsg" class="zone-alert">
    Im Logbuch, das noch auf dem Wrack der HMS Corkscrew liegt, ist noch knapp zu
    lesen: â€¦wenn mein Magen zur Abendstund knurrt, gibtâ€™s hier die letzte Runde:
    ðŸŒŠ + ðŸ‘€
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const PUBLIC_SHARE_ID = 'b995bb953c';
const POLLING_MS      = 15000;
const TRACKER_ENDPOINT = `https://floral-bread-d4f1.goldinger.workers.dev/${PUBLIC_SHARE_ID}`;

// Zone settings (center & radius in metres)
const ZONE_CENTER = [47.197610, 8.650484];   // Home: [47.197610, 8.650484] walensee: [47.126430, 9.296480] / bodensee: [47.648547, 9.330724]
const ZONE_RADIUS = 150;                     // metres (walensee = 50 / bodensee = 150)

/* password hash */
const PW_HASH_HEX = 'dd9ddae86b9ddc5a68b98636336eb90236a13f972422b7d354939c1aa40be2c6';

/* countdown target */
const COUNT_TARGET = new Date(2025, 9, 4, 11, 0, 0);   // 4 Oct 2025 11â€‰:â€‰00

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const map = L.map('map',{zoomControl:true,inertia:true}).setView([0,0],13);

const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution:'Tiles Â© Esri, Maxar, Earthstar Geographics', maxZoom:21 }
).addTo(map);

const intro = document.getElementById('intro');
satellite.once('tileload', () => intro.style.display = 'flex');

/* icons */
const userIcon    = L.icon({iconUrl:'img/user-arrow.png',iconSize:[45,80],iconAnchor:[22,40]});
const trackerIcon = L.divIcon({className:'tracker-icon',iconSize:[110,110],iconAnchor:[55,110]});
const freddyIcon  = L.icon({iconUrl:'img/wreck-icon.png',iconSize:[150,112],iconAnchor:[150,112]});

/* zone visuals */
const zoneCircle   = L.circle(ZONE_CENTER,{radius:ZONE_RADIUS,color:'#d42604',fillOpacity:.1}).addTo(map);
const freddyMarker = L.marker(ZONE_CENTER,{icon:freddyIcon,interactive:false}).addTo(map);

// distance HUD setup
const hudEl = document.getElementById('hudDistance');
function updateDistanceHud(){
  if(userMarker && trackerMarker){
  const d = map.distance(userMarker.getLatLng(), trackerMarker.getLatLng());
  hudEl.textContent = `approx. distance to the bottle: ${Math.round(d)} m`;
  }
}
  
/* scale freddy with zoom */
const B_ZOOM=13,B_W=150,B_H=112;
map.on('zoom',()=>{const f=Math.min(1,map.getZoomScale(map.getZoom(),B_ZOOM));
  const w=B_W*f,h=B_H*f,el=freddyMarker.getElement();if(el){
    el.style.width=`${w}px`;el.style.height=`${h}px`;
    el.style.marginLeft=`-${w/2}px`;el.style.marginTop=`-${h}px`;
  }}); map.fire('zoom');

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let trackerMarker,userMarker,lastLive=false,userInteracted=false;
map.on('zoomstart dragstart',()=>userInteracted=true);

const zoneMsg = document.getElementById('zoneMsg');
let insideZone=false;

/* helpers */
function fit(){
  const g=L.featureGroup([trackerMarker,userMarker,zoneCircle]);
  if(g.getLayers().length && !userInteracted) map.fitBounds(g.getBounds().pad(.25));
}
const headingFromEvent = e =>
  ('webkitCompassHeading' in e && Number.isFinite(e.webkitCompassHeading))
    ? e.webkitCompassHeading
    : Number.isFinite(e.alpha) ? (360-e.alpha)%360 : null;

/* countdown */
const cdEl=document.getElementById('countdown');
const tick=()=>{const diff=COUNT_TARGET-Date.now();
  if(diff<=0){cdEl.textContent='ðŸŽ‰ Heute ist es soweit!';clearInterval(tID);return;}
  const s=Math.floor(diff/1000)%60,m=Math.floor(diff/60000)%60,
        h=Math.floor(diff/3600000)%24,d=Math.floor(diff/86400000);
  cdEl.textContent=`${d} T ${String(h).padStart(2,'0')} h `
                  +`${String(m).padStart(2,'0')} m ${String(s).padStart(2,'0')} s`;};
const tID=setInterval(tick,1000); tick();

/* sha-256 helper */
async function sha256Hex(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ask motion/orientation immediately on click */
function requestCompassNow(){
  if(!('DeviceOrientationEvent' in window)) return;
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission()
      .then(p=>{if(p==='granted') enableOrientation();})
      .catch(()=>{});            // ignore denial
  }else{
    enableOrientation();         // Android / older iOS
  }
}
function enableOrientation(){
  window.addEventListener('deviceorientation',e=>{
    const h=headingFromEvent(e); if(h!=null&&userMarker) userMarker.setRotationAngle(h);
  },true);
}

/* geolocation + zone */
function startGeolocation(){
  if(!('geolocation' in navigator)) return;
  navigator.geolocation.watchPosition(({coords})=>{
    const {latitude,longitude,heading}=coords;
    if(!userMarker){
      userMarker=L.marker([latitude,longitude],{
        icon:userIcon,rotationAngle:heading||0,rotationOrigin:'center center'
      }).addTo(map).bindPopup("Sailor's position and heading");
    }else{
      userMarker.setLatLng([latitude,longitude]);
      if(Number.isFinite(heading)) userMarker.setRotationAngle(heading);
    }
    const dist=map.distance([latitude,longitude],ZONE_CENTER);
    if(dist<=ZONE_RADIUS&&!insideZone){insideZone=true;zoneMsg.style.display='block';}
    else if(dist>ZONE_RADIUS&&insideZone){insideZone=false;zoneMsg.style.display='none';}
    updateDistanceHud();
    fit();
  },console.warn,{enableHighAccuracy:true,maximumAge:0});
}

/* tracker polling */
async function updateTracker(){
  try{
    const r=await fetch(TRACKER_ENDPOINT); if(!r.ok) throw new Error(r.statusText);
    const d=await r.json();
    const lat=d.lat??d.position?.lat, lng=d.lng??d.lon??d.position?.lng??d.position?.lon;
    if(lat==null||lng==null) return;
    const live=d.lt_active===true, speed=d.speed, alt=d.alt;
    const ts=new Date((d.time||Date.now()/1000)*1000).toLocaleTimeString();
    const html=`<strong>Bottle's position</strong><br>`
              +(live?'<span style="color:#e63946;font-weight:bold">LIVE TRACKING</span><br>':'')
              +`Last Update: ${ts}<br>Speed: ${speed??'â€“'} m/s<br>Altitude: ${alt??'â€“'} m`;
    if(!trackerMarker){
      trackerMarker=L.marker([lat,lng],{icon:trackerIcon}).addTo(map).bindPopup(html);
    }else{
      trackerMarker.setLatLng([lat,lng]); trackerMarker.setPopupContent(html);
    }
    updateDistanceHud();
    fit();
    if(live&&!lastLive) trackerMarker.openPopup();
    else if(!live&&lastLive) trackerMarker.closePopup();
    lastLive=live;
  }catch(err){console.error('tracker',err);}
}

/* START button */
document.getElementById('startBtn').addEventListener('click', async () => {
  const pw=prompt('Bitte Passwort eingeben:'); if(!pw) return;
  requestCompassNow();                       // run while click gesture is active

  const ok = (await sha256Hex(pw)) === PW_HASH_HEX;
  if(!ok){ alert('Falsches Passwort â€“ versuch es noch einmal'); return; }

  intro.remove();
  startGeolocation();
  updateTracker(); setInterval(updateTracker,POLLING_MS);
},{once:true});
</script>
</body>
</html>
